README
====

首先要说明一下 BizServer 的几个分类, 大致分为:
- LoginServer;
- GameServer;
- ClubServer;
- FightServer;
- XxxServer;

怎么分类? 和 ServerJobTypeDef 保持一致!

那么 Client 发消息 ProxyServer 再转到各个 BizServer 是有微妙的不同的！
可以参考这张图:

```text
Client --> ProxyServer --> LoginServer ( 随即分配, 用完即走 )
                |
                +--> GameServer ( 分配一个人数最少的, 除非客户端主动断开连接否则一直保持 )
                |
                +--> ClubServer ( 根据 ClubId 固定分配, 如果服务器扩容, 则需要重新分配 )
                |
                +--> FightServer ( 分配一个人数最少的, 用完即走 )
```

客户端只跟 ProxyServer 交互, 由 ProxyServer 转发消息到各个 BizServer 上。
那么 ProxyServer 的路由规则就是上面这张图说的...
路由规则中需要考虑 BizServer 动态扩容的问题!

想象以下几个场景:

## 场景 1: 用户登陆

- 用户发送登陆消息;
- ProxyServer 接到登陆命令后, 从已知服务器中找到可以处理登陆命令的而且是人数最少的服务器, 也就是登陆服务器 ( LoginServer );
- ProxyServer 将消息转发给登陆服务器;
- 但很不巧, 用户的密码输入错误;
- 用户修改密码后重新发出登陆消息;
- ProxyServer 接到登陆命令后, 还是 "从已知服务器中找到可以处理登陆命令的而且是人数最少的服务器", 但这一次选择的服务器可能和上一次的不一样;
- 这次用户密码正确, 可以继续进行游戏;

如果对 LoginServer 进行扩容 ( 也就增加登陆服务器数量 ), 
那么上面的逻辑依然可以正常运行!
因为每一次选择登陆服务器时, 都是随机的, 且用完就走...

----

## 场景 2: 用户进入游戏并操作物品

- 用户进入游戏, 发送进入游戏的消息;
- ProxyServer 接到命令后, 从已知服务器中找到可以处理登陆命令的而且是人数最少的服务器, 也就是游戏服务器 ( GameServer );
- ProxyServer 将消息转发给游戏服务器, 并记住这个游戏服务器 Id;
- 接着用户又打开了物品面板操作物品, 发送物品相关消息;
- ProxyServer 接到命令后, 因为之前已经记住这个游戏服务器 Id, 那么这次接到的消息还转发到这个服务器上;
- 如果玩家断开连接, 那么这个 "被记住的游戏服务器 Id" 也就被忘记了;

如果对 GameServer 进行扩容 ( 也就增加游戏服务器数量 ), 
那么上面的逻辑依然可以正常运行!
因为一旦确定转发到哪个游戏服务器上, 就再也不会变了!
这样可以避免很多并发问题...
除非用户断线重连, 这样才会重新路由到别的游戏服务器上去.

----

## 场景 3: 用户进入工会

- 用户进入工会, 发送进入工会消息;
- ProxyServer 接到命令后, 根据工会 Id 进行求余运算 ( ClubId % 工会服务器数量 ), 选定工会服务器 ( ClubServer );
- ProxyServer 将消息转发给工会服务器, 并记住这个工会服务器 Id;
- 用户后续发送的工会相关消息, 也都会被转发到这个工会服务器;

这样设计的目的是可以保证多个用户同时操作工会时, 
不会因为并发问题导致数据出错...
但是, 当工会服务器扩容或缩容的时候 ( 增减工会服务器 ), 就不能用这个 "被记住的工会服务器 Id" 了!
否则在扩容的时候, 新服务器永远不会分派到;
   在缩容的时候, 旧服务器永远不会被排除掉;

为了解决上述问题,
我们不仅要记录服务器 Id, 还要记录一个版本号!
这个版本号 = 相同工作类型服务器的数量.
这样, 在服务器扩容或者缩容的时候, 版本号就会发生变化...
我们在获取服务器的时候, 可以根据服务器 Id + 版本号来获取,
当版本号不一致时, 就会清掉原来的服务器 Id 并重新选择新的服务器;

